<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Professional LTV Calculator</title>
<style>
  :root {
    --bg: #0b0f14;
    --panel: #111827;
    --panel-hover: #1a202e;
    --muted: #6b7280;
    --text: #e5e7eb;
    --accent: #22c55e;
    --accent-dark: #16a34a;
    --border: #1f2937;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    --success: #22c55e;
  }
  
  * {
    box-sizing: border-box;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  }
  
  body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    padding: 32px 16px;
    line-height: 1.5;
  }
  
  .wrap {
    max-width: 1200px;
    margin: auto;
  }
  
  header {
    margin-bottom: 32px;
  }
  
  h1 {
    margin: 0 0 8px;
    font-size: 28px;
    font-weight: 700;
  }
  
  p.sub {
    color: var(--muted);
    margin: 0;
    font-size: 15px;
  }
  
  .grid {
    display: grid;
    gap: 20px;
    grid-template-columns: repeat(12, 1fr);
  }
  
  .card {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
  }
  
  .span12 { grid-column: span 12; }
  .span6 { grid-column: span 6; }
  .span4 { grid-column: span 4; }
  
  .input-group {
    margin-bottom: 20px;
  }
  
  .input-group:last-child {
    margin-bottom: 0;
  }
  
  label {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    margin: 0 0 8px;
  }
  
  .help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: var(--border);
    color: var(--muted);
    font-size: 11px;
    cursor: help;
    font-weight: 600;
  }
  
  .help-icon:hover {
    background: #374151;
    color: var(--text);
  }
  
  .tooltip {
    position: relative;
  }
  
  .tooltip .tooltip-text {
    visibility: hidden;
    width: 240px;
    background: #1f2937;
    color: var(--text);
    text-align: left;
    border-radius: 8px;
    padding: 10px 12px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -120px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 13px;
    font-weight: 400;
    border: 1px solid var(--border);
    line-height: 1.4;
  }
  
  .tooltip .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #1f2937 transparent transparent transparent;
  }
  
  .tooltip:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
  }
  
  input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 10px;
    background: #0b1220;
    border: 1px solid var(--border);
    color: var(--text);
    font-size: 15px;
    transition: border-color 0.2s;
  }
  
  input:focus {
    outline: none;
    border-color: #374151;
  }
  
  input.error {
    border-color: var(--danger);
  }
  
  input.warning {
    border-color: var(--warning);
  }
  
  .validation-msg {
    font-size: 13px;
    margin-top: 6px;
    display: none;
  }
  
  .validation-msg.show {
    display: block;
  }
  
  .validation-msg.error {
    color: var(--danger);
  }
  
  .validation-msg.warning {
    color: var(--warning);
  }
  
  .kpi-grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }
  
  .kpi {
    padding: 20px;
    border-radius: 12px;
    background: #0c1525;
    border: 1px solid var(--border);
    transition: background 0.2s;
  }
  
  .kpi:hover {
    background: #0f1829;
  }
  
  .kpi h2 {
    margin: 0 0 8px;
    font-size: 14px;
    color: var(--muted);
    font-weight: 500;
  }
  
  .kpi .value {
    font-size: 28px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
  }
  
  .kpi .subtext {
    font-size: 13px;
    color: var(--muted);
  }
  
  .kpi.highlight .value {
    color: var(--accent);
  }
  
  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    margin-top: 8px;
  }
  
  .status-badge.good {
    background: rgba(34, 197, 94, 0.1);
    color: var(--success);
  }
  
  .status-badge.warning {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning);
  }
  
  .status-badge.poor {
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
  }
  
  .info-box {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-top: 20px;
  }
  
  .info-box h3 {
    margin: 0 0 8px;
    font-size: 15px;
    color: var(--info);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .info-box ul {
    margin: 8px 0 0;
    padding-left: 20px;
    color: var(--muted);
    font-size: 14px;
  }
  
  .info-box li {
    margin: 4px 0;
  }
  
  .btn-group {
    display: flex;
    gap: 12px;
    margin-top: 24px;
  }
  
  .btn {
    flex: 1;
    padding: 12px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
  }
  
  .btn.primary {
    background: var(--accent);
    color: #052e16;
  }
  
  .btn.primary:hover {
    background: var(--accent-dark);
  }
  
  .btn.secondary {
    background: #0b1220;
    color: var(--text);
    border: 1px solid var(--border);
  }
  
  .btn.secondary:hover {
    background: var(--panel-hover);
  }
  
  .calculation-breakdown {
    background: #0c1525;
    border-radius: 12px;
    padding: 16px;
    margin-top: 20px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.8;
  }
  
  .calculation-breakdown h3 {
    margin: 0 0 12px;
    font-size: 14px;
    font-family: ui-sans-serif, system-ui, -apple-system;
    color: var(--accent);
  }
  
  .calc-step {
    color: var(--muted);
    padding: 4px 0;
  }
  
  .calc-step strong {
    color: var(--text);
  }
  
  @media (max-width: 900px) {
    .span6, .span4 {
      grid-column: span 12;
    }
    
    .kpi-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header role="banner">
      <h1>Customer Lifetime Value Calculator</h1>
      <p class="sub">Professional-grade LTV analysis with real-time validation and insights</p>
    </header>

    <main role="main">
      <div class="grid">
        <!-- Input Section -->
        <section class="card span6" aria-label="Calculator Inputs">
          <div class="input-group">
            <label for="aov">
              Average Order Value (AOV)
              <span class="tooltip help-icon" aria-label="Help for Average Order Value">
                ?
                <span class="tooltip-text">The average amount a customer spends per transaction. Calculate by dividing total revenue by number of orders.</span>
              </span>
            </label>
            <input 
              id="aov" 
              type="number" 
              min="0" 
              step="0.01" 
              value="120"
              aria-describedby="aov-error aov-warning"
              aria-required="true"
            >
            <div id="aov-error" class="validation-msg error" role="alert"></div>
            <div id="aov-warning" class="validation-msg warning" role="status"></div>
          </div>

          <div class="input-group">
            <label for="freq">
              Purchase Frequency (per month)
              <span class="tooltip help-icon" aria-label="Help for Purchase Frequency">
                ?
                <span class="tooltip-text">How many times per month an average customer makes a purchase. E.g., 1.5 means customers buy 3 times every 2 months.</span>
              </span>
            </label>
            <input 
              id="freq" 
              type="number" 
              min="0" 
              step="0.01" 
              value="1.2"
              aria-describedby="freq-error freq-warning"
              aria-required="true"
            >
            <div id="freq-error" class="validation-msg error" role="alert"></div>
            <div id="freq-warning" class="validation-msg warning" role="status"></div>
          </div>

          <div class="input-group">
            <label for="margin">
              Gross Margin (%)
              <span class="tooltip help-icon" aria-label="Help for Gross Margin">
                ?
                <span class="tooltip-text">Percentage of revenue retained after direct costs. E.g., 70% means you keep $70 of every $100 in revenue after COGS.</span>
              </span>
            </label>
            <input 
              id="margin" 
              type="number" 
              min="0" 
              max="100" 
              step="0.1" 
              value="70"
              aria-describedby="margin-error margin-warning"
              aria-required="true"
            >
            <div id="margin-error" class="validation-msg error" role="alert"></div>
            <div id="margin-warning" class="validation-msg warning" role="status"></div>
          </div>

          <div class="input-group">
            <label for="churn">
              Monthly Churn Rate (%)
              <span class="tooltip help-icon" aria-label="Help for Churn Rate">
                ?
                <span class="tooltip-text">Percentage of customers who stop buying each month. E.g., 3.5% means you lose 3.5% of your customer base monthly.</span>
              </span>
            </label>
            <input 
              id="churn" 
              type="number" 
              min="0.01" 
              max="100" 
              step="0.01" 
              value="3.5"
              aria-describedby="churn-error churn-warning"
              aria-required="true"
            >
            <div id="churn-error" class="validation-msg error" role="alert"></div>
            <div id="churn-warning" class="validation-msg warning" role="status"></div>
          </div>

          <div class="input-group">
            <label for="cac">
              Customer Acquisition Cost (CAC) - Optional
              <span class="tooltip help-icon" aria-label="Help for CAC">
                ?
                <span class="tooltip-text">Total cost to acquire a new customer (marketing + sales expenses divided by new customers). Required for LTV/CAC ratio and payback calculations.</span>
              </span>
            </label>
            <input 
              id="cac" 
              type="number" 
              min="0" 
              step="0.01" 
              placeholder="e.g., 150"
              aria-describedby="cac-error cac-warning"
            >
            <div id="cac-error" class="validation-msg error" role="alert"></div>
            <div id="cac-warning" class="validation-msg warning" role="status"></div>
          </div>

          <div class="btn-group">
            <button id="reset" class="btn secondary" aria-label="Reset all inputs">
              Reset
            </button>
            <button id="export" class="btn secondary" aria-label="Export results">
              Export
            </button>
          </div>
        </section>

        <!-- Results Section -->
        <section class="card span6" aria-label="Results" aria-live="polite">
          <div class="kpi-grid">
            <div class="kpi highlight">
              <h2>Customer LTV</h2>
              <div id="ltv" class="value">$0.00</div>
              <div class="subtext">Lifetime value per customer</div>
            </div>

            <div class="kpi">
              <h2>ARPU / Month</h2>
              <div id="arpu" class="value">$0.00</div>
              <div class="subtext">Avg revenue per user/month</div>
            </div>

            <div class="kpi">
              <h2>Avg Lifespan</h2>
              <div id="lifespan" class="value">—</div>
              <div class="subtext">Expected customer tenure</div>
            </div>

            <div class="kpi">
              <h2>Payback Period</h2>
              <div id="payback" class="value">—</div>
              <div class="subtext">Time to recover CAC</div>
            </div>

            <div class="kpi">
              <h2>LTV / CAC Ratio</h2>
              <div id="ratio" class="value">—</div>
              <div id="ratio-status" class="subtext"></div>
            </div>
          </div>

          <div id="calculation-details" class="calculation-breakdown" style="display:none;">
            <h3>📊 Calculation Breakdown</h3>
            <div id="calc-steps"></div>
          </div>

          <div class="info-box">
            <h3>
              <span>💡</span>
              Benchmarks
            </h3>
            <ul>
              <li><strong>LTV/CAC ≥ 3:</strong> Healthy unit economics</li>
              <li><strong>Payback < 12 months:</strong> Good for most businesses</li>
              <li><strong>Churn < 5%/month:</strong> Strong retention (B2C)</li>
              <li><strong>Churn < 2%/month:</strong> Strong retention (B2B)</li>
            </ul>
          </div>
        </section>

        <!-- Formula Reference -->
        <section class="card span12" aria-label="Formula Reference">
          <h3 style="margin:0 0 12px; font-size:16px;">Formula & Methodology</h3>
          <div style="color:var(--muted); font-size:14px; line-height:1.7;">
            <p style="margin:0 0 10px;"><strong style="color:var(--text);">LTV Calculation:</strong> (AOV × Purchase Frequency × Gross Margin) / Monthly Churn</p>
            <p style="margin:0 0 10px;"><strong style="color:var(--text);">Expected Lifespan:</strong> 1 / Monthly Churn Rate</p>
            <p style="margin:0 0 10px;"><strong style="color:var(--text);">Payback Period:</strong> CAC / (ARPU × Gross Margin)</p>
            <p style="margin:0;"><strong style="color:var(--text);">Note:</strong> This uses gross margin in LTV calculations, following investor-grade best practices. Results assume consistent behavior patterns.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

<script>
  // Utility functions
  const $ = id => document.getElementById(id);
  const fmt = (n, decimals = 2) => n.toLocaleString(undefined, {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });

  // State management
  const state = {
    aov: 120,
    freq: 1.2,
    margin: 70,
    churn: 3.5,
    cac: null
  };

  // Load saved state from localStorage
  function loadState() {
    try {
      const saved = localStorage.getItem('ltvCalculatorState');
      if (saved) {
        const parsed = JSON.parse(saved);
        Object.assign(state, parsed);
        // Populate inputs
        $('aov').value = state.aov;
        $('freq').value = state.freq;
        $('margin').value = state.margin;
        $('churn').value = state.churn;
        $('cac').value = state.cac || '';
      }
    } catch (e) {
      console.error('Failed to load saved state:', e);
    }
  }

  // Save state to localStorage
  function saveState() {
    try {
      localStorage.setItem('ltvCalculatorState', JSON.stringify(state));
    } catch (e) {
      console.error('Failed to save state:', e);
    }
  }

  // Validation functions
  function validateInput(id, value, rules) {
    const errorEl = $(`${id}-error`);
    const warningEl = $(`${id}-warning`);
    const inputEl = $(id);
    
    // Clear previous validation
    errorEl.textContent = '';
    errorEl.classList.remove('show');
    warningEl.textContent = '';
    warningEl.classList.remove('show');
    inputEl.classList.remove('error', 'warning');

    // Check errors
    if (rules.required && (!value || value <= 0)) {
      errorEl.textContent = rules.requiredMsg || 'This field is required';
      errorEl.classList.add('show');
      inputEl.classList.add('error');
      return false;
    }

    if (rules.min !== undefined && value < rules.min) {
      errorEl.textContent = `Must be at least ${rules.min}`;
      errorEl.classList.add('show');
      inputEl.classList.add('error');
      return false;
    }

    if (rules.max !== undefined && value > rules.max) {
      errorEl.textContent = `Must be at most ${rules.max}`;
      errorEl.classList.add('show');
      inputEl.classList.add('error');
      return false;
    }

    // Check warnings
    if (rules.warnMin !== undefined && value < rules.warnMin) {
      warningEl.textContent = rules.warnMinMsg;
      warningEl.classList.add('show');
      inputEl.classList.add('warning');
    }

    if (rules.warnMax !== undefined && value > rules.warnMax) {
      warningEl.textContent = rules.warnMaxMsg;
      warningEl.classList.add('show');
      inputEl.classList.add('warning');
    }

    return true;
  }

  // Calculate and update UI
  function calculate() {
    const aov = parseFloat($('aov').value) || 0;
    const freq = parseFloat($('freq').value) || 0;
    const marginPct = parseFloat($('margin').value) || 0;
    const churnPct = parseFloat($('churn').value) || 0;
    const cac = parseFloat($('cac').value) || null;

    // Update state
    state.aov = aov;
    state.freq = freq;
    state.margin = marginPct;
    state.churn = churnPct;
    state.cac = cac;
    saveState();

    // Validate all inputs
    const isAovValid = validateInput('aov', aov, {
      required: true,
      min: 0,
      warnMin: 10,
      warnMinMsg: 'AOV seems unusually low',
      warnMax: 10000,
      warnMaxMsg: 'AOV seems unusually high'
    });

    const isFreqValid = validateInput('freq', freq, {
      required: true,
      min: 0,
      warnMin: 0.1,
      warnMinMsg: 'Very low purchase frequency',
      warnMax: 10,
      warnMaxMsg: 'Very high purchase frequency (10+ per month)'
    });

    const isMarginValid = validateInput('margin', marginPct, {
      required: true,
      min: 0,
      max: 100,
      warnMin: 10,
      warnMinMsg: 'Low margin may indicate pricing issues',
      warnMax: 95,
      warnMaxMsg: 'Unusually high margin'
    });

    const isChurnValid = validateInput('churn', churnPct, {
      required: true,
      requiredMsg: 'Churn rate must be greater than 0%',
      min: 0.01,
      max: 100,
      warnMax: 20,
      warnMaxMsg: 'Very high churn rate (>20%/month)'
    });

    if (cac) {
      validateInput('cac', cac, {
        min: 0,
        warnMax: 5000,
        warnMaxMsg: 'High CAC - ensure profitability'
      });
    }

    // Stop if any validation failed
    if (!isAovValid || !isFreqValid || !isMarginValid || !isChurnValid) {
      return;
    }

    // Perform calculations
    const margin = marginPct / 100;
    const churn = churnPct / 100;
    const arpuMonth = aov * freq;
    const lifespanMonths = 1 / churn;
    const ltv = arpuMonth * margin * lifespanMonths;

    // Update displays
    $('ltv').textContent = fmt(ltv);
    $('arpu').textContent = fmt(arpuMonth);
    $('lifespan').textContent = lifespanMonths.toFixed(1) + ' months';

    // CAC-dependent calculations
    if (cac && cac > 0) {
      const ratio = ltv / cac;
      const arpuMargin = arpuMonth * margin;
      const paybackMonths = arpuMargin > 0 ? cac / arpuMargin : Infinity;

      $('ratio').textContent = ratio.toFixed(2) + '×';
      $('payback').textContent = paybackMonths === Infinity ? '∞' : paybackMonths.toFixed(1) + ' mo';

      // Status indicator
      const statusEl = $('ratio-status');
      if (ratio >= 3) {
        statusEl.innerHTML = '<span class="status-badge good">Excellent</span>';
      } else if (ratio >= 2) {
        statusEl.innerHTML = '<span class="status-badge warning">Fair</span>';
      } else {
        statusEl.innerHTML = '<span class="status-badge poor">Poor</span>';
      }
    } else {
      $('ratio').textContent = '—';
      $('payback').textContent = '—';
      $('ratio-status').innerHTML = '<span style="font-size:12px;">Enter CAC for ratio</span>';
    }

    // Show calculation breakdown
    showCalculationBreakdown(aov, freq, marginPct, churnPct, cac, arpuMonth, margin, churn, lifespanMonths, ltv);
  }

  // Show detailed calculation breakdown
  function showCalculationBreakdown(aov, freq, marginPct, churnPct, cac, arpuMonth, margin, churn, lifespanMonths, ltv) {
    const steps = `
      <div class="calc-step">ARPU/month = <strong>$${aov.toFixed(2)}</strong> × <strong>${freq.toFixed(2)}</strong> = <strong>${fmt(arpuMonth)}</strong></div>
      <div class="calc-step">Gross Margin = <strong>${marginPct.toFixed(1)}%</strong> = <strong>${(margin * 100).toFixed(1)}%</strong></div>
      <div class="calc-step">Expected Lifespan = <strong>1 / ${churnPct.toFixed(2)}%</strong> = <strong>${lifespanMonths.toFixed(1)} months</strong></div>
      <div class="calc-step">LTV = <strong>${fmt(arpuMonth)}</strong> × <strong>${(margin * 100).toFixed(1)}%</strong> × <strong>${lifespanMonths.toFixed(1)}</strong> = <strong>${fmt(ltv)}</strong></div>
      ${cac ? `<div class="calc-step">LTV/CAC = <strong>${fmt(ltv)}</strong> / <strong>${fmt(cac)}</strong> = <strong>${(ltv/cac).toFixed(2)}×</strong></div>` : ''}
    `;
    
    $('calc-steps').innerHTML = steps;
    $('calculation-details').style.display = 'block';
  }

  // Export results
  function exportResults() {
    const data = {
      timestamp: new Date().toISOString(),
      inputs: {
        aov: state.aov,
        frequency: state.freq,
        margin: state.margin + '%',
        churn: state.churn + '%',
        cac: state.cac || 'N/A'
      },
      results: {
        ltv: $('ltv').textContent,
        arpu: $('arpu').textContent,
        lifespan: $('lifespan').textContent,
        payback: $('payback').textContent,
        ltvCacRatio: $('ratio').textContent
      }
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ltv-analysis-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Reset to defaults
  function reset() {
    $('aov').value = 120;
    $('freq').value = 1.2;
    $('margin').value = 70;
    $('churn').value = 3.5;
    $('cac').value = '';
    calculate();
  }

  // Event listeners with debouncing for performance
  ['aov', 'freq', 'margin', 'churn', 'cac'].forEach(id => {
    $(id).addEventListener('input', calculate);
    // Add enter key support
    $(id).addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        calculate();
      }
    });
  });

  $('reset').addEventListener('click', reset);
  $('export').addEventListener('click', exportResults);

  // Add keyboard shortcut info
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + E to export
    if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
      e.preventDefault();
      exportResults();
    }
    // Ctrl/Cmd + R to reset (prevent browser refresh)
    if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
      e.preventDefault();
      reset();
    }
  });

  // Initialize
  loadState();
  calculate();
  
  // Show helpful tip on first load
  if (!localStorage.getItem('ltvCalculatorVisited')) {
    localStorage.setItem('ltvCalculatorVisited', 'true');
    console.log('💡 Pro Tips:\n- Hover over the "?" icons for detailed explanations\n- Use Ctrl+E to export, Ctrl+R to reset\n- Your inputs are automatically saved');
  }
</script>
</body>
</html>
